<!DOCTYPE html>
<html>
<head>
    <title>Galloners Club - Tracking</title>
    <meta charset="UTF-8">
    <style>
        body { margin:0; font-family:Arial; background:#f4f4f4; }

        header {
            background:#b30000;
            color:white;
            padding:15px;
            text-align:center;
        }

        .logo { width:100px; display:block; margin:10px auto; }

        .container {
            max-width:95%;
            margin:20px auto;
            background:white;
            padding:20px;
            border-radius:10px;
            box-shadow:0 3px 10px rgba(0,0,0,0.1);
        }

        table { width:100%; border-collapse:collapse; }

        th, td {
            padding:8px;
            border:1px solid #ddd;
            text-align:center;
        }

        th { background:#b30000; color:white; }

        button {
            padding:5px 8px;
            margin:2px;
            border:none;
            border-radius:4px;
            cursor:pointer;
            color:white;
        }

        .edit-btn { background:#2196F3; }
        .delete-btn { background:#f44336; }
        .view-btn { background:#9c27b0; }
        .filter-btn { background:#555; }
    </style>
</head>

<body>

<header>
    <img src="images/logo.png" class="logo">
    <h2>Donor Tracking</h2>
</header>

<div class="container">

<!-- ADDED SEARCH + EXPORT + RETURN -->
<input type="text" id="searchInput" placeholder="Search donor..."
onkeyup="searchDonor()" style="margin-bottom:10px; padding:5px;">

<button onclick="exportToGoogleSheet()">Export to Google Sheet</button>
<button onclick="goDashboard()">Return to Dashboard</button>

<br><br>

<!-- CATEGORY BUTTONS -->
<button class="filter-btn" onclick="filterByCategory('galloner')">Galloners</button>
<button class="filter-btn" onclick="filterByCategory('bronze')">Bronze</button>
<button class="filter-btn" onclick="filterByCategory('silver')">Silver</button>
<button class="filterByCategory('gold')" onclick="filterByCategory('gold')">Gold</button>
<button onclick="renderTable()">Show All</button>

<br><br>

<table>
    <thead>
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Blood Type</th>
            <th>Contact</th>
            <th>Serial Count</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="donorTable"></tbody>
</table>

</div>

<script>

function renderTable(filteredType=null){
    let donors = JSON.parse(localStorage.getItem("donors")) || [];
    let table = document.getElementById("donorTable");
    table.innerHTML = "";

    donors.forEach((donor,index)=>{
        let serialCount = donor.serials ? donor.serials.length : 0;

        if(filteredType){
            if(filteredType==="galloner" && serialCount<8) return;
            if(filteredType==="bronze" && serialCount<28) return;
            if(filteredType==="silver" && serialCount<46) return;
            if(filteredType==="gold" && serialCount<70) return;
        }

        table.innerHTML += `
        <tr>
            <td>${index+1}</td>
            <td>${donor.firstName} ${donor.middleName} ${donor.surname}</td>
            <td>${donor.bloodType || ""}</td>
            <td>${donor.contact || ""}</td>
            <td>
                ${serialCount}
                <button class="view-btn" onclick="toggleSerial(${index})">View</button>
            </td>
            <td>
                <button class="edit-btn" onclick="editDonor(${index})">Edit</button>
                <button class="delete-btn" onclick="deleteDonor(${index})">Delete</button>
            </td>
        </tr>
        <tr id="serialRow${index}" style="display:none;">
            <td colspan="6" id="serialList${index}"></td>
        </tr>
        `;
    });
}

function filterByCategory(type){
    renderTable(type);
}

function toggleSerial(index){
    let donors = JSON.parse(localStorage.getItem("donors")) || [];
    let row = document.getElementById("serialRow"+index);
    let container = document.getElementById("serialList"+index);

    if(row.style.display==="none"){
        let serials = donors[index].serials || [];
        container.innerHTML = "";

        if(serials.length===0){
            container.innerHTML="No serial numbers.";
        }else{
            serials.forEach((s,i)=>{
                container.innerHTML += `
                ${s.number} 
                <button class="delete-btn" onclick="deleteSerial(${index},${i})">
                Delete
                </button><br>`;
            });
        }

        row.style.display="table-row";
    }else{
        row.style.display="none";
    }
}

function deleteSerial(donorIndex,serialIndex){
    let donors = JSON.parse(localStorage.getItem("donors")) || [];
    donors[donorIndex].serials.splice(serialIndex,1);
    localStorage.setItem("donors",JSON.stringify(donors));
    renderTable();
}

function deleteDonor(index){
    let donors = JSON.parse(localStorage.getItem("donors")) || [];
    donors.splice(index,1);
    localStorage.setItem("donors",JSON.stringify(donors));
    renderTable();
}

function editDonor(index){
    localStorage.setItem("editIndex", index);
    window.location.href="donor-entry.html";
}

function searchDonor(){
    let input=document.getElementById("searchInput").value.toLowerCase();
    let rows=document.querySelectorAll("#donorTable tr");

    rows.forEach(row=>{
        let text=row.innerText.toLowerCase();
        row.style.display=text.includes(input)?"":"none";
    });
}

function exportToGoogleSheet(){
    let donors=JSON.parse(localStorage.getItem("donors"))||[];

    fetch("YOUR_GOOGLE_SCRIPT_URL",{
        method:"POST",
        body:JSON.stringify(donors),
        headers:{"Content-Type":"application/json"}
    })
    .then(()=>alert("Exported successfully"))
    .catch(()=>alert("Export failed"));
}

function goDashboard(){
    window.location.href="dashboard.html";
}

renderTable();

</script>

</body>
</html>
