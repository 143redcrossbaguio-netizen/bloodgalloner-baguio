<!DOCTYPE html>
<html>
<head>
    <title>Galloners Club - Tracking</title>
    <meta charset="UTF-8">
    <style>
        body { margin:0; font-family:Arial; background:#f4f4f4; }
        header { background:#b30000; color:white; padding:15px; text-align:center; }
        .logo { width:100px; display:block; margin:10px auto; }
        .container { max-width:95%; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:8px; border:1px solid #ddd; text-align:center; }
        th { background:#b30000; color:white; }
        button { padding:5px 8px; margin:2px; border:none; border-radius:4px; cursor:pointer; color:white; }
        .edit-btn { background:#1565c0; }
        .delete-btn { background:#c62828; }
        .view-btn { background:#6a1b9a; }
        .top-btn { background:#b30000; }
        .galloner-btn { background:#1e88e5; }
        .bronze-btn { background:#cd7f32; }
        .silver-btn { background:#9e9e9e; }
        .gold-btn { background:#d4af37; color:black; }
        .filter-btn { background:#222; }

        .serial-box {
            background:#f9f9f9;
            border:1px solid #ccc;
            padding:10px;
            border-radius:6px;
        }

        .serial-item {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:6px;
        }

        .serial-item input { padding:4px; margin-right:5px; }
    </style>
</head>
<body>

<header>
    <img src="images/logo.png" class="logo">
    <h2>Donor Tracking</h2>
</header>

<div class="container">

<input type="text" id="searchInput" placeholder="Search donor..."
onkeyup="searchDonor()" style="margin-bottom:10px; padding:5px;">

<button class="top-btn" onclick="exportToCSV()">Export CSV</button>
<button class="top-btn" onclick="goDashboard()">Return to Dashboard</button>

<br><br>

<select id="bloodFilter" onchange="renderTable()">
    <option value="">All Blood Types</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="AB">AB</option>
    <option value="O">O</option>
</select>

<br><br>

<button class="galloner-btn" onclick="filterByCategory('galloner')">Galloners</button>
<button class="bronze-btn" onclick="filterByCategory('bronze')">Bronze</button>
<button class="silver-btn" onclick="filterByCategory('silver')">Silver</button>
<button class="gold-btn" onclick="filterByCategory('gold')">Gold</button>
<button class="filter-btn" onclick="renderTable()">Show All</button>

<br><br>

<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Blood Type</th>
<th>Contact</th>
<th>Serial Count</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="donorTable"></tbody>
</table>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyByh0YJ11ZpbRV7EoDoLnqgFxe1r68efPI",
    authDomain: "galloners-club.firebaseapp.com",
    projectId: "galloners-club",
    storageBucket: "galloners-club.appspot.com",
    messagingSenderId: "213049860421",
    appId: "1:213049860421:web:4156aaa52b945f48711e2c",
    measurementId: "G-XYXJH9JNXJ"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let donorData = []; // cached donors
let categoryLimits = { galloner:8, bronze:28, silver:46, gold:70 };

async function getDonors(){
    try {
        const snapshot = await database.ref('donors').get();
        donorData = snapshot.exists() ? snapshot.val() : [];
        return donorData;
    } catch(e){ console.error(e); return []; }
}

async function renderTable(category=null){
    let donors = await getDonors();
    let table = document.getElementById("donorTable");
    let selectedBloodType = document.getElementById("bloodFilter").value;
    table.innerHTML = "";

    if(donors.length === 0){ table.innerHTML = `<tr><td colspan="6">No donors found</td></tr>`; return; }

    donors.forEach((donor,index)=>{
        let serialCount = donor.serials ? donor.serials.length : 0;
        if(selectedBloodType && donor.bloodType !== selectedBloodType) return;

        if(category){
            if(category==="galloner" && serialCount < categoryLimits.galloner) return;
            if(category==="bronze" && serialCount < categoryLimits.bronze) return;
            if(category==="silver" && serialCount < categoryLimits.silver) return;
            if(category==="gold" && serialCount < categoryLimits.gold) return;
        }

        table.innerHTML += `
        <tr>
            <td>${index+1}</td>
            <td>${donor.firstName || ""} ${donor.middleName || ""} ${donor.surname || ""}</td>
            <td>${donor.bloodType || ""} ${donor.rhFactor || ""}</td>
            <td>${donor.contact || ""}</td>
            <td>
                ${serialCount}
                <button class="view-btn" onclick="toggleSerial(${index})">View</button>
            </td>
            <td>
                <button class="edit-btn" onclick="editDonor(${index})">Edit</button>
                <button class="delete-btn" onclick="deleteDonor(${index})">Delete</button>
            </td>
        </tr>
        <tr id="serialRow${index}" style="display:none;">
            <td colspan="6">
                <div class="serial-box" id="serialList${index}"></div>
            </td>
        </tr>
        `;
    });
}

function goDashboard(){ window.location.href = "dashboard.html"; }

function filterByCategory(type){ renderTable(type); }

function searchDonor(){
    let input = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#donorTable tr").forEach(row=>{
        row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
    });
}

async function toggleSerial(index){
    let donors = await getDonors();
    let row = document.getElementById("serialRow"+index);
    let container = document.getElementById("serialList"+index);

    if(row.style.display==="none"){
        container.innerHTML="";
        let serials = donors[index].serials || [];
        serials.forEach((s,i)=>{
            container.innerHTML += `
                <div class="serial-item">
                    <div>
                        <input type="text" value="${s.serial}" disabled>
                        <input type="date" value="${s.date}" disabled>
                    </div>
                </div>`;
        });
        row.style.display="table-row";
    } else { row.style.display="none"; }
}

function editDonor(index){
    localStorage.setItem("editIndex", index);
    window.location.href="donor-entry.html";
}

async function deleteDonor(index){
    if(!confirm("Are you sure you want to delete this donor?")) return;
    let donors = await getDonors();
    donors.splice(index,1);
    await database.ref('donors').set(donors);
    renderTable();
}

async function exportToCSV(){
    let donors = await getDonors();
    let csv = "Blood Type,Rh Factor,First Name,Middle Name,Surname,Birthday,Contact\n";
    donors.forEach(d=>{
        csv += `${d.bloodType || ""},${d.rhFactor || ""},${d.firstName || ""},${d.middleName || ""},${d.surname || ""},${d.birthday || ""},${d.contact || ""}\n`;
    });
    let blob = new Blob([csv], { type: "text/csv" });
    let url = window.URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "donors.csv";
    a.click();
    window.URL.revokeObjectURL(url);
}

window.onload = function(){ renderTable(); }

</script>

</body>
</html>
