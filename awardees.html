<!DOCTYPE html>
<html>
<head>
    <title>Awardees Monitoring</title>
    <meta charset="UTF-8">

    <style>
        body { margin:0; font-family:Arial; background:#f4f4f4; }
        header { background:#b30000; color:white; padding:15px; text-align:center; }
        .container { max-width:95%; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }

        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { border:1px solid #ddd; padding:8px; text-align:center; }
        th { background:#b30000; color:white; }

        button {
            padding:4px 8px;
            margin:2px;
            border:none;
            border-radius:4px;
            cursor:pointer;
            color:white;
        }

        .awarded { background:#2e7d32; }
        .notawarded { background:#c62828; }
        .claimed { background:#1565c0; }
        .unclaimed { background:#6a1b9a; }

        input[type="date"] { padding:3px; margin-left:5px; }

        .save-btn {
            background:#ff9800;
            color:white;
            padding:4px 8px;
            border:none;
            border-radius:4px;
            cursor:pointer;
            margin-left:5px;
        }

        .top-btn {
            background:#b30000;
            color:white;
            padding:8px 12px;
            border:none;
            border-radius:5px;
            cursor:pointer;
            margin-bottom:15px;
        }

        .filters { margin-bottom:15px; }
        select { padding:5px; margin-right:10px; }
    </style>
</head>

<body>

<header>
    <h2>Awardees Monitoring</h2>
</header>

<div class="container">

<button class="top-btn" onclick="goDashboard()">Return to Dashboard</button>

<div class="filters">
    <select id="bloodFilter" onchange="renderAwardees()">
        <option value="">All Blood Types</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="AB">AB</option>
        <option value="O">O</option>
    </select>

    <select id="statusFilter" onchange="renderAwardees()">
        <option value="">All Statuses</option>
        <option value="awarded">Awarded</option>
        <option value="notawarded">Not Awarded</option>
        <option value="claimed">Claimed</option>
        <option value="unclaimed">Unclaimed</option>
    </select>
</div>

<table>
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Blood Type</th>
<th>Serial Count</th>
<th>Awarded</th>
<th>Claimed</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody id="awardContainer"></tbody>
</table>

</div>

<script>
// --- Helpers ---
function getDonors(){
    let data = localStorage.getItem("donors");
    if(!data) return [];
    return JSON.parse(data);
}

function getCategoryLimits(){
    let settings = localStorage.getItem("categorySettings");
    if(!settings) return { galloner:8, bronze:28, silver:46, gold:70 };
    return JSON.parse(settings);
}

// --- Render Awardees ---
function renderAwardees(){
    let donors = getDonors();
    let limits = getCategoryLimits();
    let container = document.getElementById("awardContainer");
    let bloodFilter = document.getElementById("bloodFilter").value;
    let statusFilter = document.getElementById("statusFilter").value;

    container.innerHTML = "";

    let categories = { galloner:limits.galloner, bronze:limits.bronze, silver:limits.silver, gold:limits.gold };
    let rowIndex = 1;

    for(let category in categories){
        donors.forEach((donor,index)=>{
            let serialCount = donor.serials ? donor.serials.length : 0;
            if(serialCount < categories[category]) return;
            if(bloodFilter && donor.bloodType !== bloodFilter) return;
            if(statusFilter && (!donor.awardStatus || !donor.awardStatus[statusFilter])) return;

            let fullName = `${donor.firstName || ""} ${donor.middleName || ""} ${donor.surname || ""}`;

            let awardedDate = donor.awardStatus && donor.awardStatus.awarded ? donor.awardStatus.awarded : "";
            let claimedDate = donor.awardStatus && donor.awardStatus.claimed ? donor.awardStatus.claimed : "";

            container.innerHTML += `
                <tr id="row${index}${category}">
                    <td>${rowIndex++}</td>
                    <td>${fullName}</td>
                    <td>${donor.bloodType || ""} ${donor.rhFactor || ""}</td>
                    <td>${serialCount}</td>
                    <td>
                        <button class="awarded" onclick="setTempStatus(${index},'awarded','${category}')">Awarded</button>
                        <button class="notawarded" onclick="setTempStatus(${index},'notawarded','${category}')">Not Awarded</button>
                    </td>
                    <td>
                        <button class="claimed" onclick="setTempStatus(${index},'claimed','${category}')">Claimed</button>
                        <button class="unclaimed" onclick="setTempStatus(${index},'unclaimed','${category}')">Unclaimed</button>
                    </td>
                    <td>
                        <input type="date" id="tempDate${index}${category}" value="${awardedDate || claimedDate}" style="display:none;">
                    </td>
                    <td>
                        <button class="save-btn" id="saveBtn${index}${category}" style="display:none;" onclick="saveStatus(${index},'${category}')">Save</button>
                    </td>
                </tr>
            `;
        });
    }
}

// --- Temporary Status Store ---
let tempStatusStore = {};

function setTempStatus(index,type,category){
    let dateInput = document.getElementById("tempDate"+index+category);
    let saveBtn = document.getElementById("saveBtn"+index+category);

    dateInput.style.display = "inline-block";
    saveBtn.style.display = "inline-block";

    tempStatusStore[index] = tempStatusStore[index] || {};
    tempStatusStore[index][category] = { type: type, date: new Date().toISOString().split("T")[0] };

    dateInput.value = tempStatusStore[index][category].date;
}

// --- Save Status ---
function saveStatus(index,category){
    let donors = getDonors();
    if(!donors[index].awardStatus) donors[index].awardStatus = {};

    if(tempStatusStore[index] && tempStatusStore[index][category]){
        let ts = tempStatusStore[index][category];
        donors[index].awardStatus[ts.type] = document.getElementById("tempDate"+index+category).value;
    }

    localStorage.setItem("donors", JSON.stringify(donors));

    document.getElementById("tempDate"+index+category).style.display = "none";
    document.getElementById("saveBtn"+index+category).style.display = "none";

    renderAwardees();
}

function goDashboard(){ window.location.href="dashboard.html"; }

window.onload = function(){ renderAwardees(); };

</script>

</body>
</html>
